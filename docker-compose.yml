services:
  kd_api:
    image: node:20
    container_name: kd_api
    working_dir: /usr/src/app
    volumes:
      - ./api:/usr/src/app
    command: bash -c "npm install && npm run dev"
    environment:
      - DATABASE_URL=postgres://derby_admin:${DB_PASS}@192.168.50.209:5432/derby
      - API_ADMIN_PASS=${API_ADMIN_PASS}
    ports:
      - "4000:4000"
    restart: unless-stopped

  kd_frontend_builder:
    image: node:20
    container_name: kd_frontend_builder
    working_dir: /usr/src/app
    volumes:
      - ./frontend:/usr/src/app
      - /websites/kd_race_app:/output
    command: bash -c "npm install && npm run build && cp -r dist/* /output"
    profiles: ["build"]
    restart: on-failure

  kd_nginx:
    image: nginx:alpine
    container_name: kd_nginx
    depends_on:
      - kd_api
      - kd_frontend_builder
    ports:
      - "8086:80"
    volumes:
      - /websites/kd_race_app:/usr/share/nginx/html:ro
      - ./nginx/kd.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
