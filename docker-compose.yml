services:
  # ğŸ—ï¸ One-off builder for frontend assets â€“ run manually or via testing_rebuild.sh
  kd_frontend_builder:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
    volumes:
      - kd_race_app_dist_assets:/app/frontend/dist
    # â±ï¸ Do not auto-run â€“ this is used for dev/testing only

  # ğŸš€ API backend serving routes and static frontend
  kd_api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    volumes:
      - kd_race_app_dist_assets:/app/public  # Serves prebuilt frontend files
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgres://derby_admin:${DB_PASS}@192.168.50.209:5432/derby
      - API_ADMIN_PASS=${API_ADMIN_PASS}
    restart: unless-stopped
    networks:
      - kd_net

  # ğŸŒ Nginx reverse proxy serving frontend + proxying API and sockets
  kd_nginx:
    image: nginx:alpine
    ports:
      - "8086:80"
    volumes:
      - kd_race_app_dist_assets:/usr/share/nginx/html:ro
      - ./nginx/kd.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      - kd_net

# âœ… Consistent volume used everywhere
volumes:
  kd_race_app_dist_assets:

networks:
  kd_net:
    driver: bridge