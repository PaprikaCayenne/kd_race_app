# ğŸš€ Docker Compose configuration for KD Race App
# Version: v1.2.9 â€“ Move copy step outside node user to fix permission issues
# Services: API backend, frontend builder, and Nginx reverse proxy

services:
  # ğŸ´ kd_api â€“ Node.js + Express + Prisma backend
  kd_api:
    build:
      context: ./api
      dockerfile: Dockerfile
      args:
        NODE_ENV: production

    container_name: kd_api
    working_dir: /usr/src/app
    user: "node"  # ğŸ‘¤ Non-root user for safer volume writes

    # Optional: enable during local development
    # volumes:
    #   - ./api:/usr/src/app:cached

    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgres://derby_admin:${DB_PASS}@192.168.50.209:5432/derby
      - API_ADMIN_PASS=${API_ADMIN_PASS}

    ports:
      - "4000:4000"  # REST & WebSocket
      - "5555:5555"  # Optional: Prisma Studio

    restart: unless-stopped
    networks:
      - kd_net

  # âš™ï¸ kd_frontend_builder â€“ compiles Vite frontend using pnpm
  kd_frontend_builder:
    image: node:20
    container_name: kd_frontend_builder
    working_dir: /usr/src/app
    user: "root"  # ğŸ‘· Required to handle file ownership correction

    volumes:
      - type: volume
        source: frontend_node_modules
        target: /usr/src/app/node_modules
      - type: volume
        source: frontend_cache
        target: /usr/src/app/.pnpm-store
      - ./frontend:/usr/src/app:cached         # Editable React + Vite project
      - /websites/kd_race_app:/output           # Output directory for final built assets

    environment:
      COREPACK_ENABLE_STRICT: "0"
      NODE_OPTIONS: "--no-warnings"
      PUID: "1007"
      PGID: "1003"

    command: >
      bash -c "
        echo 'ğŸ§¹ Cleaning up old files (as root)...' &&
        rm -rf /usr/src/app/dist /usr/src/app/.vite /usr/src/app/.vite-temp /output/* &&

        echo 'ğŸ”§ Fixing ownership of workspace to media-apps (PUID=1007, PGID=1003)...' &&
        chown -R $PUID:$PGID /usr/src/app /output &&

        echo 'ğŸ”’ Fixing permissions before build...' &&
        mkdir -p /usr/src/app/.npm /usr/src/app/.local/share/pnpm &&
        chown -R node:node /usr/src/app /usr/src/app/.npm /usr/src/app/.local &&
        chmod -R 755 /usr/src/app/.local/share/pnpm &&

        echo 'ğŸ›† Installing deps and building as node user (inside owned workspace)...' &&
        su node -c '
          export HOME=/usr/src/app &&
          npx pnpm install --no-frozen-lockfile &&
          npx pnpm run build
        ' &&

        echo 'ğŸ“¦ Copying built files to output (as root)...' &&
        cp -r dist/* /output &&

        echo 'ğŸ”“ Ensuring output is world-readable for Nginx...' &&
        chmod -R 755 /output &&

        echo 'âœ… Build complete'
      "

    restart: on-failure
    networks:
      - kd_net

  # ğŸŒ kd_nginx â€“ serves frontend and proxies backend API/WebSocket
  kd_nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile

    container_name: kd_nginx
    depends_on:
      - kd_api

    ports:
      - "8086:80"  # External HTTP port

    volumes:
      - /websites/kd_race_app:/usr/share/nginx/html:ro     # ğŸ“† Built frontend
      - ./nginx/kd.conf:/etc/nginx/conf.d/default.conf:ro  # âš–ï¸ Custom routing config

    restart: unless-stopped
    networks:
      - kd_net

# ğŸ”Œ Shared Docker network
networks:
  kd_net:
    name: kd_net
    driver: bridge

# ğŸ©± Volumes to isolate cached dependencies and store
volumes:
  frontend_node_modules:
  frontend_cache:
