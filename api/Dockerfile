# ğŸ´ Dockerfile for kd_api â€“ Node.js + Prisma backend API
# Version: v1.1.1 â€“ Safe volume mount support + non-root runtime + correct file ownership

##########################
# Stage 1: Builder Layer #
##########################
FROM node:20 AS builder

# ğŸ“ App directory
WORKDIR /usr/src/app

# ğŸ“¦ Install dependencies without optional native modules
COPY package*.json ./
RUN npm install --omit=optional

# ğŸ§¬ Generate Prisma client
COPY ./prisma ./prisma
RUN npx prisma generate --schema=./prisma/schema.prisma

# ğŸ§¼ Fix ownership to non-root user (node = UID 1000)
RUN chown -R node:node /usr/src/app

# ğŸ“ Copy full source late for build cache benefits
COPY . .

##############################
# Stage 2: Final Runtime App #
##############################
FROM node:20

# ğŸ  App dir in final image
WORKDIR /usr/src/app

# ğŸ‘¤ Run as safe user (matches LXC bind volumes)
USER node

# ğŸ“¦ Copy necessary build output
COPY --chown=node:node --from=builder /usr/src/app/node_modules ./node_modules
COPY --chown=node:node --from=builder /usr/src/app/prisma ./prisma
COPY --chown=node:node --from=builder /usr/src/app/package*.json ./
COPY --chown=node:node --from=builder /usr/src/app/*.js ./
COPY --chown=node:node --from=builder /usr/src/app/routes ./routes
COPY --chown=node:node --from=builder /usr/src/app/lib ./lib
COPY --chown=node:node --from=builder /usr/src/app/sockets ./sockets

# ğŸŒ API + WebSocket port
EXPOSE 4000

# ğŸš€ Launch app (non-dev)
CMD ["node", "index.js"]
