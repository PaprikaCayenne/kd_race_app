# KD_API: Node.js backend for races
FROM node:20

# ğŸ“ Set working directory
WORKDIR /usr/src/app

# ğŸ“¦ Copy only package files first (to optimize layer caching)
COPY package*.json ./

# ğŸŒ Set environment variable
ARG NODE_ENV=production
ENV NODE_ENV=$NODE_ENV

# âœ… Install Prisma CLI and client in separate steps
# This prevents the @prisma/engines module not found error
RUN npm install --save-dev prisma
RUN npm install @prisma/client

# ğŸ“¦ Install other dependencies
RUN if [ "$NODE_ENV" = "development" ]; then \
      npm install; \
    else \
      npm install --omit=dev; \
    fi

# ğŸ§¬ Copy schema before generating the Prisma client
COPY prisma ./prisma
RUN npx prisma generate --schema=./prisma/schema.prisma

# ğŸ“‚ Copy the rest of your application last
COPY . .

# ğŸšª Expose port for API + WebSockets
EXPOSE 4000

# â–¶ï¸ Start the server
CMD ["node", "index.js"]
